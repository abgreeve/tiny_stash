{"version":3,"file":"additem.min.js","sources":["../src/additem.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add a new item internal\n *\n * @copyright  2023 Adrian Greeve <adriangreeve.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Fragment from 'core/fragment';\nimport Templates from 'core/templates';\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport * as Toast from 'core/toast';\n\nlet CourseId = 0;\nexport let Status = 'Clear';\n\nexport const init = (courseid, contextid) => {\n    CourseId = courseid;\n\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    Fragment.loadFragment('tiny_stash', 'add_item_form', contextid ,{courseid}).then((html, js) => {\n        Templates.appendNodeContents(areanode, html, js);\n    });\n\n    Templates.render('tiny_stash/local/footers/add-item-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n        addFooterListeners();\n    });\n};\n\n/**\n * Remove all the children from a node.\n *\n * @param {node} node - The node to remove the children from.\n */\nexport const removeChildren = (node) => {\n    while (node.firstChild) {\n        node.removeChild(node.lastChild);\n    }\n};\n\n/**\n * Add listeners to the footer buttons.\n */\nconst addFooterListeners = () => {\n    let backbutton = document.querySelector('button[data-action=\"back\"]');\n    backbutton.addEventListener('click', (e) => {\n        shiftBack(e);\n    });\n    let addbutton = document.querySelector('button[data-action=\"add\"]');\n    addbutton.addEventListener('click', (e) => {\n        saveItem(e);\n    });\n};\n\n/**\n * Shift the carousel back.\n *\n * @param {event} e - The related event.\n */\nconst shiftBack = (e) => {\n    e.preventDefault();\n    $('.carousel').carousel('prev');\n    $('.carousel').carousel('pause');\n    // Clear this page.\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    removeChildren(areanode);\n    // Replace footer.\n    Templates.render('tiny_stash/local/footers/main-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n    });\n};\n\nconst saveItem = (event) => {\n    let formdata = document.querySelector('.tiny-stash-next-slide form');\n    let submitdata = {\n        itemname: formdata.querySelector('#id_name').value,\n        scarceitem: formdata.querySelector('#id_scarceitem').checked,\n        amountlimit: (formdata.querySelector('#id_amountlimit').value) ? formdata.querySelector('#id_amountlimit').value : 0,\n        itemimage: formdata.querySelector('#id_image').value,\n        description: formdata.querySelector('#id_detail_text').value,\n    };\n    validateForm(submitdata).then((result) => {\n        if (result) {\n            createItem(submitdata).then(() => {\n                Status = 'Saved';\n                shiftBack(event);\n            });\n        }\n    });\n};\n\nconst validateForm = async (formdata) => {\n    window.console.log(formdata);\n    await Toast.addToastRegion(document.querySelector('.tiny-stash-next-slide'));\n    if (!formdata.itemname) {\n        Toast.add('Please add a name for the item', {\n            type: 'warning',\n            autohide: true,\n            closeButton: true,\n        });\n        // Focus on the element.\n        document.querySelector('#id_name').focus();\n        return false;\n    }\n    let hoboy = document.querySelector('.tiny-stash-next-slide form');\n    let yeppo = hoboy.querySelector('.fp-content');\n    // window.console.log(yeppo.children.length);\n    if (yeppo.children.length < 1) {\n        Toast.add('Please add an image for the item', {\n            type: 'warning',\n            autohide: true,\n            closeButton: true,\n        });\n        // Focus on the element.\n        document.querySelector('#id_image').focus();\n        return false;\n    }\n    return true;\n};\n\nconst createItem = (itemdata) => Ajax.call([{\n    methodname: 'block_stash_add_item',\n    args: {\n        courseid: CourseId,\n        itemname: itemdata.itemname,\n        scarceitem: itemdata.scarceitem,\n        amountlimit: itemdata.amountlimit,\n        itemimage: itemdata.itemimage,\n        description: itemdata.description,\n    }\n}])[0];\n"],"names":["CourseId","Status","courseid","contextid","areanode","document","querySelector","loadFragment","then","html","js","appendNodeContents","render","modalfooter","removeChildren","addFooterListeners","node","firstChild","removeChild","lastChild","addEventListener","e","shiftBack","saveItem","preventDefault","carousel","event","formdata","submitdata","itemname","value","scarceitem","checked","amountlimit","itemimage","description","validateForm","result","createItem","async","window","console","log","Toast","addToastRegion","add","type","autohide","closeButton","focus","children","length","itemdata","Ajax","call","methodname","args"],"mappings":";;;;;;87BA4BIA,SAAW,EACJC,OAAS,6CAEA,CAACC,SAAUC,aAC3BH,SAAWE,aAEPE,SAAWC,SAASC,cAAc,4CAC7BC,aAAa,aAAc,gBAAiBJ,UAAW,CAACD,SAAAA,WAAWM,MAAK,CAACC,KAAMC,yBAC1EC,mBAAmBP,SAAUK,KAAMC,0BAGvCE,OAAO,2CAA4C,IAAIJ,MAAK,CAACC,KAAMC,UACrEG,YAAcR,SAASC,cAAc,iBAEzCQ,eAAeD,gCACLF,mBAAmBE,YAAaJ,KAAMC,IAChDK,+BASKD,eAAkBE,YACpBA,KAAKC,YACRD,KAAKE,YAAYF,KAAKG,yDAOxBJ,mBAAqB,KACNV,SAASC,cAAc,8BAC7Bc,iBAAiB,SAAUC,IAClCC,UAAUD,MAEEhB,SAASC,cAAc,6BAC7Bc,iBAAiB,SAAUC,IACjCE,SAASF,OASXC,UAAaD,IACfA,EAAEG,qCACA,aAAaC,SAAS,4BACtB,aAAaA,SAAS,aAEpBrB,SAAWC,SAASC,cAAc,0BACtCQ,eAAeV,6BAELQ,OAAO,uCAAwC,IAAIJ,MAAK,CAACC,KAAMC,UACjEG,YAAcR,SAASC,cAAc,iBAEzCQ,eAAeD,gCACLF,mBAAmBE,YAAaJ,KAAMC,QAIlDa,SAAYG,YACVC,SAAWtB,SAASC,cAAc,+BAClCsB,WAAa,CACbC,SAAUF,SAASrB,cAAc,YAAYwB,MAC7CC,WAAYJ,SAASrB,cAAc,kBAAkB0B,QACrDC,YAAcN,SAASrB,cAAc,mBAAmBwB,MAASH,SAASrB,cAAc,mBAAmBwB,MAAQ,EACnHI,UAAWP,SAASrB,cAAc,aAAawB,MAC/CK,YAAaR,SAASrB,cAAc,mBAAmBwB,OAE3DM,aAAaR,YAAYpB,MAAM6B,SACvBA,QACAC,WAAWV,YAAYpB,MAAK,qBACxBP,OAAS,QACTqB,UAAUI,cAMpBU,aAAeG,MAAAA,cACjBC,OAAOC,QAAQC,IAAIf,gBACbgB,MAAMC,eAAevC,SAASC,cAAc,4BAC7CqB,SAASE,gBACVc,MAAME,IAAI,iCAAkC,CACxCC,KAAM,UACNC,UAAU,EACVC,aAAa,IAGjB3C,SAASC,cAAc,YAAY2C,SAC5B,UAEC5C,SAASC,cAAc,+BACjBA,cAAc,eAEtB4C,SAASC,OAAS,KACxBR,MAAME,IAAI,mCAAoC,CAC1CC,KAAM,UACNC,UAAU,EACVC,aAAa,IAGjB3C,SAASC,cAAc,aAAa2C,SAC7B,IAKTX,WAAcc,UAAaC,cAAKC,KAAK,CAAC,CACxCC,WAAY,uBACZC,KAAM,CACFtD,SAAUF,SACV6B,SAAUuB,SAASvB,SACnBE,WAAYqB,SAASrB,WACrBE,YAAamB,SAASnB,YACtBC,UAAWkB,SAASlB,UACpBC,YAAaiB,SAASjB,gBAE1B"}