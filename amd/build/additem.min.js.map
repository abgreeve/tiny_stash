{"version":3,"file":"additem.min.js","sources":["../src/additem.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add a new item internal\n *\n * @copyright  2023 Adrian Greeve <adriangreeve.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Fragment from 'core/fragment';\nimport Templates from 'core/templates';\nimport $ from 'jquery';\nimport * as Toast from 'core/toast';\nimport * as WebService from 'tiny_stash/webservice-calls';\nimport {getContextId} from 'editor_tiny/options';\nimport {getCourseId} from 'tiny_stash/options';\nimport * as DropAdd from 'tiny_stash/drop-add';\nimport {get_string as getString} from 'core/str';\nimport * as itemGetter from 'block_stash/local/datasources/items-getter';\n\nlet CourseId = 0;\nlet Editor = {};\nlet Status = 'Clear';\nlet Item = {};\n\nconst SAVEONLY = 'save';\nconst SAVEGAIN = 'gain';\nconst SAVELOSS = 'loss';\nconst SAVELOCATION = 'savelocation';\n\nexport const init = (editor, location) => {\n    Editor = editor;\n    let contextid = getContextId(editor);\n    CourseId = getCourseId(editor);\n    let courseid = CourseId;\n\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    Fragment.loadFragment('tiny_stash', 'add_item_form', contextid ,{courseid}).then((html, js) => {\n        Templates.appendNodeContents(areanode, html, js);\n    });\n\n    let footerdata = {};\n    if (location == 'location') {\n        footerdata.location = true;\n    }\n    if (location == 'trade') {\n        footerdata.trade = true;\n    }\n\n    Templates.render('tiny_stash/local/footers/add-item-footer', footerdata).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n        addFooterListeners(location);\n    });\n};\n\nexport const setStatus = (newstatus) => {\n    Status = newstatus;\n};\n\nexport const getStatus = () => {\n    return Status;\n};\n\nexport const getItem = () => {\n    return Item;\n};\n\n/**\n * Remove all the children from a node.\n *\n * @param {node} node - The node to remove the children from.\n */\nexport const removeChildren = (node) => {\n    while (node.firstChild) {\n        node.removeChild(node.lastChild);\n    }\n};\n\n/**\n * Add listeners to the footer buttons.\n *\n * @param {string} location - The location of where we came from.\n */\nconst addFooterListeners = (location) => {\n    let backbutton = document.querySelector('button[data-action=\"back\"]');\n    backbutton.addEventListener('click', (e) => {\n        shiftBack(e, location);\n    });\n    if (location == 'location') {\n        let addbutton = document.querySelector('button[data-action=\"add\"]');\n        addbutton.addEventListener('click', (e) => {\n            saveItem(e, SAVEONLY);\n        });\n        let addlocationbutton = document.querySelector('button[data-action=\"add-and-location\"]');\n        addlocationbutton.addEventListener('click', (e) => {\n            saveItem(e, SAVELOCATION);\n        });\n    } else {\n        let addbutton = document.querySelector('button[data-action=\"add-gain\"]');\n        addbutton.addEventListener('click', (e) => {\n            saveItem(e, SAVEGAIN);\n        });\n        let addbuttonloss = document.querySelector('button[data-action=\"add-loss\"]');\n        addbuttonloss.addEventListener('click', (e) => {\n            saveItem(e, SAVELOSS);\n        });\n    }\n};\n\n/**\n * Shift the carousel back.\n *\n * @param {event} e - The related event.\n * @param {string} location - The location of where we came from.\n */\nconst shiftBack = (e, location) => {\n    e.preventDefault();\n    if (location == 'trade') {\n        $('.carousel').carousel(3);\n    } else {\n        $('.carousel').carousel('prev');\n    }\n    $('.carousel').carousel('pause');\n    // Clear this page.\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    removeChildren(areanode);\n    // Replace footer.\n    if (location == 'trade') {\n        Templates.render('tiny_stash/local/footers/add-trade-footer', {}).then((html, js) => {\n            let modalfooter = document.querySelector('.modal-footer');\n            // Remove existing buttons.\n            removeChildren(modalfooter);\n            Templates.appendNodeContents(modalfooter, html, js);\n        });\n    } else {\n        Templates.render('tiny_stash/local/footers/main-footer', {}).then((html, js) => {\n            let modalfooter = document.querySelector('.modal-footer');\n            // Remove existing buttons.\n            removeChildren(modalfooter);\n            Templates.appendNodeContents(modalfooter, html, js);\n        });\n    }\n};\n\nconst saveItem = (event, aftersave) => {\n    let formdata = document.querySelector('.tiny-stash-next-slide form');\n    let submitdata = {\n        itemname: formdata.querySelector('#id_name').value,\n        scarceitem: formdata.querySelector('#id_scarceitem').checked,\n        amountlimit: (formdata.querySelector('#id_amountlimit').value) ? formdata.querySelector('#id_amountlimit').value : 0,\n        itemimage: formdata.querySelector('#id_image').value,\n        description: formdata.querySelector('#id_detail_text').value,\n    };\n    validateForm(submitdata).then((result) => {\n        if (result) {\n            WebService.createItem(CourseId, submitdata).then((itemdata) => {\n                itemGetter.resetCache();\n                Status = 'Saved';\n                if (aftersave == SAVELOCATION) {\n                    addLocation(event, itemdata);\n                } else if (aftersave == SAVEONLY) {\n                    shiftBack(event);\n                } else if (aftersave == SAVEGAIN) {\n                    // Save to gain column.\n                    Status = SAVEGAIN;\n                    Item = itemdata;\n                    shiftBack(event, 'trade');\n                } else {\n                    // Save to loss column.\n                    Status = SAVELOSS;\n                    Item = itemdata;\n                    shiftBack(event, 'trade');\n                }\n            });\n        }\n    });\n};\n\nconst addLocation = (e, itemdata) => {\n    e.preventDefault();\n    $('.carousel').carousel('next');\n    $('.carousel').carousel('pause');\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    removeChildren(areanode);\n    DropAdd.init({itemdata}, Editor);\n};\n\nconst validateForm = async (formdata) => {\n    window.console.log(formdata);\n    await Toast.addToastRegion(document.querySelector('.tiny-stash-next-slide'));\n    if (!formdata.itemname) {\n        Toast.add(getString('namewarning', 'tiny_stash'), {\n            type: 'warning',\n            autohide: true,\n            closeButton: true,\n        });\n        // Focus on the element.\n        document.querySelector('#id_name').focus();\n        return false;\n    }\n    let hoboy = document.querySelector('.tiny-stash-next-slide form');\n    let yeppo = hoboy.querySelector('.fp-content');\n    // window.console.log(yeppo.children.length);\n    if (yeppo.children.length < 1) {\n        Toast.add(getString('imagewarning', 'tiny_stash'), {\n            type: 'warning',\n            autohide: true,\n            closeButton: true,\n        });\n        // Focus on the element.\n        document.querySelector('#id_image').focus();\n        return false;\n    }\n    return true;\n};\n"],"names":["CourseId","Editor","Status","Item","editor","location","contextid","courseid","areanode","document","querySelector","loadFragment","then","html","js","appendNodeContents","footerdata","trade","render","modalfooter","removeChildren","addFooterListeners","newstatus","node","firstChild","removeChild","lastChild","addEventListener","e","shiftBack","saveItem","preventDefault","carousel","event","aftersave","formdata","submitdata","itemname","value","scarceitem","checked","amountlimit","itemimage","description","validateForm","result","WebService","createItem","itemdata","itemGetter","resetCache","addLocation","DropAdd","init","async","window","console","log","Toast","addToastRegion","add","type","autohide","closeButton","focus","children","length"],"mappings":"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"}