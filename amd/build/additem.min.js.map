{"version":3,"file":"additem.min.js","sources":["../src/additem.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add a new item internal\n *\n * @copyright  2023 Adrian Greeve <adriangreeve.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Fragment from 'core/fragment';\nimport Templates from 'core/templates';\nimport $ from 'jquery';\nimport * as Toast from 'core/toast';\nimport * as WebService from 'tiny_stash/webservice-calls';\nimport {getContextId} from 'editor_tiny/options';\nimport {getCourseId} from 'tiny_stash/options';\nimport * as DropAdd from 'tiny_stash/drop-add';\nimport {get_string as getString} from 'core/str';\n\nlet CourseId = 0;\nlet Editor = {};\nlet Status = 'Clear';\n\nexport const init = (editor) => {\n    Editor = editor;\n    let contextid = getContextId(editor);\n    CourseId = getCourseId(editor);\n    let courseid = CourseId;\n\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    Fragment.loadFragment('tiny_stash', 'add_item_form', contextid ,{courseid}).then((html, js) => {\n        Templates.appendNodeContents(areanode, html, js);\n    });\n\n    Templates.render('tiny_stash/local/footers/add-item-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n        addFooterListeners();\n    });\n};\n\nexport const setStatus = (newstatus) => {\n    Status = newstatus;\n};\n\nexport const getStatus = () => {\n    return Status;\n};\n\n/**\n * Remove all the children from a node.\n *\n * @param {node} node - The node to remove the children from.\n */\nexport const removeChildren = (node) => {\n    while (node.firstChild) {\n        node.removeChild(node.lastChild);\n    }\n};\n\n/**\n * Add listeners to the footer buttons.\n */\nconst addFooterListeners = () => {\n    let backbutton = document.querySelector('button[data-action=\"back\"]');\n    backbutton.addEventListener('click', (e) => {\n        shiftBack(e);\n    });\n    let addbutton = document.querySelector('button[data-action=\"add\"]');\n    addbutton.addEventListener('click', (e) => {\n        saveItem(e);\n    });\n};\n\n/**\n * Shift the carousel back.\n *\n * @param {event} e - The related event.\n */\nconst shiftBack = (e) => {\n    e.preventDefault();\n    $('.carousel').carousel('prev');\n    $('.carousel').carousel('pause');\n    // Clear this page.\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    removeChildren(areanode);\n    // Replace footer.\n    Templates.render('tiny_stash/local/footers/main-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n    });\n};\n\nconst saveItem = (event) => {\n    let formdata = document.querySelector('.tiny-stash-next-slide form');\n    let submitdata = {\n        itemname: formdata.querySelector('#id_name').value,\n        scarceitem: formdata.querySelector('#id_scarceitem').checked,\n        amountlimit: (formdata.querySelector('#id_amountlimit').value) ? formdata.querySelector('#id_amountlimit').value : 0,\n        itemimage: formdata.querySelector('#id_image').value,\n        description: formdata.querySelector('#id_detail_text').value,\n    };\n    validateForm(submitdata).then((result) => {\n        if (result) {\n            WebService.createItem(CourseId, submitdata).then((itemdata) => {\n                Status = 'Saved';\n                if (document.querySelector('.submit-then-drop').checked) {\n                    addLocation(event, itemdata);\n                } else {\n                    shiftBack(event);\n                }\n            });\n        }\n    });\n};\n\nconst addLocation = (e, itemdata) => {\n    e.preventDefault();\n    $('.carousel').carousel('next');\n    $('.carousel').carousel('pause');\n    let areanode = document.querySelector('.tiny-stash-next-slide');\n    removeChildren(areanode);\n    DropAdd.init({itemdata}, Editor);\n};\n\nconst validateForm = async (formdata) => {\n    window.console.log(formdata);\n    await Toast.addToastRegion(document.querySelector('.tiny-stash-next-slide'));\n    if (!formdata.itemname) {\n        Toast.add(getString('namewarning', 'tiny_stash'), {\n            type: 'warning',\n            autohide: true,\n            closeButton: true,\n        });\n        // Focus on the element.\n        document.querySelector('#id_name').focus();\n        return false;\n    }\n    let hoboy = document.querySelector('.tiny-stash-next-slide form');\n    let yeppo = hoboy.querySelector('.fp-content');\n    // window.console.log(yeppo.children.length);\n    if (yeppo.children.length < 1) {\n        Toast.add(getString('imagewarning', 'tiny_stash'), {\n            type: 'warning',\n            autohide: true,\n            closeButton: true,\n        });\n        // Focus on the element.\n        document.querySelector('#id_image').focus();\n        return false;\n    }\n    return true;\n};\n"],"names":["CourseId","Editor","Status","editor","contextid","courseid","areanode","document","querySelector","loadFragment","then","html","js","appendNodeContents","render","modalfooter","removeChildren","addFooterListeners","newstatus","node","firstChild","removeChild","lastChild","addEventListener","e","shiftBack","saveItem","preventDefault","carousel","event","formdata","submitdata","itemname","value","scarceitem","checked","amountlimit","itemimage","description","validateForm","result","WebService","createItem","itemdata","addLocation","DropAdd","init","async","window","console","log","Toast","addToastRegion","add","type","autohide","closeButton","focus","children","length"],"mappings":";;;;;;mZAgCIA,SAAW,EACXC,OAAS,GACTC,OAAS,sBAEQC,SACjBF,OAASE,WACLC,WAAY,yBAAaD,QAC7BH,UAAW,yBAAYG,YACnBE,SAAWL,SAEXM,SAAWC,SAASC,cAAc,4CAC7BC,aAAa,aAAc,gBAAiBL,UAAW,CAACC,SAAAA,WAAWK,MAAK,CAACC,KAAMC,yBAC1EC,mBAAmBP,SAAUK,KAAMC,0BAGvCE,OAAO,2CAA4C,IAAIJ,MAAK,CAACC,KAAMC,UACrEG,YAAcR,SAASC,cAAc,iBAEzCQ,eAAeD,gCACLF,mBAAmBE,YAAaJ,KAAMC,IAChDK,4CAIkBC,YACtBhB,OAASgB,8BAGY,IACdhB,aAQEc,eAAkBG,YACpBA,KAAKC,YACRD,KAAKE,YAAYF,KAAKG,yDAOxBL,mBAAqB,KACNV,SAASC,cAAc,8BAC7Be,iBAAiB,SAAUC,IAClCC,UAAUD,MAEEjB,SAASC,cAAc,6BAC7Be,iBAAiB,SAAUC,IACjCE,SAASF,OASXC,UAAaD,IACfA,EAAEG,qCACA,aAAaC,SAAS,4BACtB,aAAaA,SAAS,aAEpBtB,SAAWC,SAASC,cAAc,0BACtCQ,eAAeV,6BAELQ,OAAO,uCAAwC,IAAIJ,MAAK,CAACC,KAAMC,UACjEG,YAAcR,SAASC,cAAc,iBAEzCQ,eAAeD,gCACLF,mBAAmBE,YAAaJ,KAAMC,QAIlDc,SAAYG,YACVC,SAAWvB,SAASC,cAAc,+BAClCuB,WAAa,CACbC,SAAUF,SAAStB,cAAc,YAAYyB,MAC7CC,WAAYJ,SAAStB,cAAc,kBAAkB2B,QACrDC,YAAcN,SAAStB,cAAc,mBAAmByB,MAASH,SAAStB,cAAc,mBAAmByB,MAAQ,EACnHI,UAAWP,SAAStB,cAAc,aAAayB,MAC/CK,YAAaR,SAAStB,cAAc,mBAAmByB,OAE3DM,aAAaR,YAAYrB,MAAM8B,SACvBA,QACAC,WAAWC,WAAW1C,SAAU+B,YAAYrB,MAAMiC,WAC9CzC,OAAS,QACLK,SAASC,cAAc,qBAAqB2B,QAC5CS,YAAYf,MAAOc,UAEnBlB,UAAUI,cAOxBe,YAAc,CAACpB,EAAGmB,YACpBnB,EAAEG,qCACA,aAAaC,SAAS,4BACtB,aAAaA,SAAS,aACpBtB,SAAWC,SAASC,cAAc,0BACtCQ,eAAeV,UACfuC,QAAQC,KAAK,CAACH,SAAAA,UAAW1C,SAGvBsC,aAAeQ,MAAAA,cACjBC,OAAOC,QAAQC,IAAIpB,gBACbqB,MAAMC,eAAe7C,SAASC,cAAc,4BAC7CsB,SAASE,gBACVmB,MAAME,KAAI,mBAAU,cAAe,cAAe,CAC9CC,KAAM,UACNC,UAAU,EACVC,aAAa,IAGjBjD,SAASC,cAAc,YAAYiD,SAC5B,UAEClD,SAASC,cAAc,+BACjBA,cAAc,eAEtBkD,SAASC,OAAS,KACxBR,MAAME,KAAI,mBAAU,eAAgB,cAAe,CAC/CC,KAAM,UACNC,UAAU,EACVC,aAAa,IAGjBjD,SAASC,cAAc,aAAaiD,SAC7B"}