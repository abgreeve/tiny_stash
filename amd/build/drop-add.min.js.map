{"version":3,"file":"drop-add.min.js","sources":["../src/drop-add.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * The internal workings of the add location dialogue.\n *\n * @copyright  2023 Adrian Greeve <adriangreeve.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Templates from 'core/templates';\nimport {getCourseId} from 'tiny_stash/options';\nimport * as WebService from 'tiny_stash/webservice-calls';\n\nlet ItemsData = {};\nlet Editor = {};\nexport let Status = 'Clear';\nexport let SavedIndex = '';\n\n/**\n * Initialisation function for the drop add modal.\n *\n * @param {object} itemsData - The data for the items.\n * @param {TinyMCE} editor - The editor object.\n */\nexport const init = (itemsData, editor) => {\n    ItemsData = itemsData;\n    Editor = editor;\n    let areanode = document.querySelector('.tiny-stash-location');\n    // format items for export to the template.\n    let data = {items: []};\n    for (let item of Object.entries(ItemsData)) {\n        data.items.push({id: item[1].id, name: item[1].name});\n    }\n    if (data.items.length === 1) {\n        data.oneonly = true;\n    }\n\n    if (areanode) {\n        Templates.render('tiny_stash/stash-drop-form', data).then((html, js) => {\n            Templates.appendNodeContents(areanode, html, js);\n        });\n    }\n\n    Templates.render('tiny_stash/local/footers/add-drop-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        addFormListeners();\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n        addFooterListeners();\n    });\n};\n\n/**\n * Add event listeners for the form.\n */\nconst addFormListeners = () => {\n    const suppliesnode = document.querySelector('.location-supplies');\n    const unlimitedflag = document.querySelector('#supplyunlimited');\n    const pickupinterval = document.querySelector('.pickupinterval');\n    const intervalnumber = document.querySelector('.intervalnumber');\n\n    const updateFields = () => {\n        if (suppliesnode.value > 1 || unlimitedflag.checked) {\n            pickupinterval.disabled = false;\n            intervalnumber.disabled = false;\n        } else {\n            pickupinterval.disabled = true;\n            intervalnumber.disabled = true;\n        }\n    };\n\n    const addListener = (node) => {\n        node.addEventListener('change', updateFields);\n        node.addEventListener('keyup', updateFields);\n    };\n\n    addListener(suppliesnode);\n    addListener(unlimitedflag);\n};\n\n/**\n * Remove all the children from a node.\n *\n * @param {node} node - The node to remove the children from.\n */\nexport const removeChildren = (node) => {\n    while (node.firstChild) {\n        node.removeChild(node.lastChild);\n    }\n};\n\n/**\n * Save the drop.\n *\n * @param {event} e - The related event.\n */\nconst saveLocation = (e) => {\n    let itemnode = document.querySelector('.stash-item');\n    let itemvalue = 0;\n    if ((\"id\" in itemnode.dataset)) {\n        itemvalue = itemnode.dataset.id;\n    } else {\n        itemvalue = itemnode.options[itemnode.selectedIndex].value;\n    }\n\n    let locationnode = document.querySelector('.location-name').value;\n    let suppliesnode = document.querySelector('.location-supplies').value;\n    let suppliesunlimitednode = document.querySelector('#supplyunlimited').checked;\n    let intervalnumber = document.querySelector('.intervalnumber').value;\n    let pickupintervalnode = document.querySelector('.pickupinterval');\n    let pickupinterval = pickupintervalnode.options[pickupintervalnode.selectedIndex].value;\n    if (suppliesunlimitednode) {\n        suppliesnode = 0;\n    }\n    let realinterval = intervalnumber * pickupinterval;\n    let data = {\n        itemid: itemvalue,\n        location: locationnode,\n        supplies: suppliesnode,\n        unlimited: suppliesunlimitednode,\n        pickupinterval: realinterval\n    };\n    let courseid = getCourseId(Editor);\n    WebService.createDrop(courseid, data).then((hashcode) => {\n        SavedIndex = hashcode;\n        Status = 'Saved';\n        shiftBack(e);\n    });\n};\n\n/**\n * Add listeners to the footer buttons.\n */\nconst addFooterListeners = () => {\n    let backbutton = document.querySelector('button[data-action=\"back\"]');\n    backbutton.addEventListener('click', (e) => {\n        shiftBack(e);\n    });\n    let addbutton = document.querySelector('button[data-action=\"add\"]');\n    addbutton.addEventListener('click', (e) => {\n        saveLocation(e);\n    });\n};\n\n/**\n * Shift the carousel back.\n *\n * @param {event} e - The related event.\n */\nconst shiftBack = (e) => {\n    e.preventDefault();\n    $('.carousel').carousel(0);\n    $('.carousel').carousel('pause');\n    // Clear this page.\n    let areanode = document.querySelector('.tiny-stash-location');\n    removeChildren(areanode);\n    // Replace footer.\n    Templates.render('tiny_stash/local/footers/main-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n    });\n};\n"],"names":["ItemsData","Editor","Status","SavedIndex","itemsData","editor","areanode","document","querySelector","data","items","item","Object","entries","push","id","name","length","oneonly","render","then","html","js","appendNodeContents","modalfooter","addFormListeners","removeChildren","addFooterListeners","suppliesnode","unlimitedflag","pickupinterval","intervalnumber","updateFields","value","checked","disabled","addListener","node","addEventListener","firstChild","removeChild","lastChild","e","shiftBack","itemnode","itemvalue","dataset","options","selectedIndex","locationnode","suppliesunlimitednode","pickupintervalnode","itemid","location","supplies","unlimited","courseid","WebService","createDrop","hashcode","saveLocation","preventDefault","carousel"],"mappings":";;;;;;44BA2BIA,UAAY,GACZC,OAAS,GACFC,OAAS,mCACTC,WAAa,gDAQJ,CAACC,UAAWC,UAC5BL,UAAYI,UACZH,OAASI,WACLC,SAAWC,SAASC,cAAc,wBAElCC,KAAO,CAACC,MAAO,QACd,IAAIC,QAAQC,OAAOC,QAAQb,WAC5BS,KAAKC,MAAMI,KAAK,CAACC,GAAIJ,KAAK,GAAGI,GAAIC,KAAML,KAAK,GAAGK,OAEzB,IAAtBP,KAAKC,MAAMO,SACXR,KAAKS,SAAU,GAGfZ,6BACUa,OAAO,6BAA8BV,MAAMW,MAAK,CAACC,KAAMC,yBACnDC,mBAAmBjB,SAAUe,KAAMC,0BAI3CH,OAAO,2CAA4C,IAAIC,MAAK,CAACC,KAAMC,UACrEE,YAAcjB,SAASC,cAAc,iBACzCiB,mBAEAC,eAAeF,gCACLD,mBAAmBC,YAAaH,KAAMC,IAChDK,+BAOFF,iBAAmB,WACfG,aAAerB,SAASC,cAAc,sBACtCqB,cAAgBtB,SAASC,cAAc,oBACvCsB,eAAiBvB,SAASC,cAAc,mBACxCuB,eAAiBxB,SAASC,cAAc,mBAExCwB,aAAe,KACbJ,aAAaK,MAAQ,GAAKJ,cAAcK,SACxCJ,eAAeK,UAAW,EAC1BJ,eAAeI,UAAW,IAE1BL,eAAeK,UAAW,EAC1BJ,eAAeI,UAAW,IAI5BC,YAAeC,OACjBA,KAAKC,iBAAiB,SAAUN,cAChCK,KAAKC,iBAAiB,QAASN,eAGnCI,YAAYR,cACZQ,YAAYP,gBAQHH,eAAkBW,YACpBA,KAAKE,YACRF,KAAKG,YAAYH,KAAKI,yDA8CxBd,mBAAqB,KACNpB,SAASC,cAAc,8BAC7B8B,iBAAiB,SAAUI,IAClCC,UAAUD,MAEEnC,SAASC,cAAc,6BAC7B8B,iBAAiB,SAAUI,IA3CnBA,CAAAA,QACdE,SAAWrC,SAASC,cAAc,eAClCqC,UAAY,EAEZA,UADC,OAAQD,SAASE,QACNF,SAASE,QAAQ/B,GAEjB6B,SAASG,QAAQH,SAASI,eAAef,UAGrDgB,aAAe1C,SAASC,cAAc,kBAAkByB,MACxDL,aAAerB,SAASC,cAAc,sBAAsByB,MAC5DiB,sBAAwB3C,SAASC,cAAc,oBAAoB0B,QACnEH,eAAiBxB,SAASC,cAAc,mBAAmByB,MAC3DkB,mBAAqB5C,SAASC,cAAc,mBAE5C0C,wBACAtB,aAAe,OAGfnB,KAAO,CACP2C,OAAQP,UACRQ,SAAUJ,aACVK,SAAU1B,aACV2B,UAAWL,sBACXpB,eANeC,eAJEoB,mBAAmBJ,QAAQI,mBAAmBH,eAAef,OAY9EuB,UAAW,wBAAYvD,QAC3BwD,WAAWC,WAAWF,SAAU/C,MAAMW,MAAMuC,+BACxCxD,WAAawD,yBACbzD,OAAS,QACTyC,UAAUD,OAcVkB,CAAalB,OASfC,UAAaD,IACfA,EAAEmB,qCACA,aAAaC,SAAS,uBACtB,aAAaA,SAAS,aAEpBxD,SAAWC,SAASC,cAAc,wBACtCkB,eAAepB,6BAELa,OAAO,uCAAwC,IAAIC,MAAK,CAACC,KAAMC,UACjEE,YAAcjB,SAASC,cAAc,iBAEzCkB,eAAeF,gCACLD,mBAAmBC,YAAaH,KAAMC"}