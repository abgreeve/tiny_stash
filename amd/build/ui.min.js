define("tiny_stash/ui",["exports","core/modal_factory","core/modal_events","core/templates","editor_tiny/options","tiny_stash/options","jquery","tiny_stash/drop-add","tiny_stash/additem","tiny_stash/addtrade","tiny_stash/helptabs","tiny_stash/local/classes/snippetmaker","tiny_stash/webservice-calls","core/str"],(function(_exports,_modal_factory,_modal_events,_templates,_options,_options2,_jquery,DropAdd,AddItem,AddTrade,Help,_snippetmaker,WebService,_str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny stash UI.
   *
   * @module      tiny_stash/ui
   * @copyright   2023 Adrian Greeve <adriangreeve.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.handleAction=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),_jquery=_interopRequireDefault(_jquery),DropAdd=_interopRequireWildcard(DropAdd),AddItem=_interopRequireWildcard(AddItem),AddTrade=_interopRequireWildcard(AddTrade),Help=_interopRequireWildcard(Help),_snippetmaker=_interopRequireDefault(_snippetmaker),WebService=_interopRequireWildcard(WebService);let itemsData={},tradeData={},Snippet={};_exports.handleAction=editor=>{displayDialogue(editor)};const displayDialogue=async editor=>{let contextid=(0,_options.getContextId)(editor),data=await getDropData(contextid),courseid=(0,_options2.getCourseId)(editor);await updateItems(courseid),formatTradeInformation(data.trades,itemsData);const modalPromises=await _modal_factory.default.create({title:(0,_str.get_string)("modalheading","tiny_stash"),type:_modal_factory.default.types.SAVE_CANCEL,body:_templates.default.render("tiny_stash/drop-code-selector",data),large:!0});modalPromises.show();const $root=await modalPromises.getRoot(),root=$root[0];let savedata={};$root.on(_modal_events.default.hidden,(()=>{modalPromises.destroy()})),$root.on(_modal_events.default.bodyRendered,(()=>{Help.init(),addTabListeners(),addDropListener(editor),addAppearanceListener(),addTextAndImageListener();let additembuttons=document.querySelectorAll(".tiny-stash-add-item");for(let additembutton of additembuttons)additembutton.addEventListener("click",(e=>{e.preventDefault(),(0,_jquery.default)(".carousel").carousel("next"),(0,_jquery.default)(".carousel").carousel("pause");let location=e.currentTarget.dataset.location;AddItem.init(editor,location)}));document.querySelector(".tiny-stash-add-trade").addEventListener("click",(e=>{e.preventDefault(),(0,_jquery.default)(".carousel").carousel(3),(0,_jquery.default)(".carousel").carousel("pause"),AddTrade.init(editor)})),(0,_jquery.default)(".carousel").on("slide.bs.carousel",(async()=>{"Saved"==DropAdd.getStatus()&&(data=await getDropData(contextid),_templates.default.render("tiny_stash/drop-select",data).then(((html,js)=>{let selectnode=document.querySelector(".tiny-stash-drop-select");_templates.default.replaceNodeContents(selectnode,html,js);let selectitemnode=document.querySelector(".tiny-stash-item-select");for(let i=0;i<selectitemnode.options.length;i++){let option=selectitemnode.options[i];option.dataset.hash==DropAdd.SavedIndex&&(option.selected=!0,setPreview(option.dataset.id,option.dataset.hash))}addDropListener(editor)})),DropAdd.setStatus("Clear")),"Saved"==AddItem.getStatus()&&(updateItems(courseid),AddItem.setStatus("Clear")),"Saved"==AddTrade.getStatus()&&(await updateItems(courseid),data=await getDropData(contextid),formatTradeInformation(data.trades,itemsData),_templates.default.render("tiny_stash/local/selectors/trade-drop-selector",data).then(((html,js)=>{let selectnode=document.querySelector(".tiny-stash-trade-select");_templates.default.replaceNodeContents(selectnode,html,js);let selectitemnode=document.querySelector(".tiny-stash-trade-selector");for(let i=0;i<selectitemnode.options.length;i++){let option=selectitemnode.options[i];if(option.dataset.hash==AddTrade.TradeHash){option.selected=!0;let codearea=document.getElementsByClassName("tiny-stash-trade-code"),dropcode='[stashtrade secret="'+option.dataset.hash+'"]';codearea[0].innerText=dropcode,setTradePreview(option.dataset.hash)}}})),AddTrade.setStatus("ready"))}))})),$root.on(_modal_events.default.save,(()=>{let codearea="";codearea="items"==document.querySelector('[aria-selected="true"][data-tiny-stash]').getAttribute("aria-controls")?document.getElementsByClassName("tiny-stash-item-code"):document.getElementsByClassName("tiny-stash-trade-code"),savedata.codearea=codearea[0].innerText,editor.execCommand("mceInsertContent",!1,savedata.codearea)})),root.addEventListener("click",(event=>{let element=event.target,elementtype=element.dataset.type;if("OPTION"===element.nodeName&&"item"==elementtype&&setPreview(element.dataset.id,element.dataset.hash),"OPTION"===element.nodeName&&"trade"==elementtype){let codearea=document.getElementsByClassName("tiny-stash-trade-code"),dropcode='[stashtrade secret="'+element.dataset.hash+'"]';codearea[0].innerText=dropcode,setTradePreview(element.dataset.hash)}}))},updateItems=async courseid=>{itemsData={};let itemdata=await getItemData(courseid);itemdata.items&&itemdata.items.forEach((item=>{itemsData[item.id]=item}))},addTabListeners=()=>{document.querySelectorAll(".tiny-stash-tabs").forEach((tabnode=>{tabnode.addEventListener("click",(e=>{if("help-tab"==e.currentTarget.children[0].attributes.id.value)return;document.querySelector('button[data-action="save"]')||_templates.default.render("tiny_stash/local/footers/main-footer",{}).then(((html,js)=>{let modalfooter=document.querySelector(".modal-footer");AddItem.removeChildren(modalfooter),_templates.default.appendNodeContents(modalfooter,html,js)}))}))}))},addDropListener=editor=>{document.getElementsByClassName("tiny-stash-add-drop")[0].addEventListener("click",(e=>{e.preventDefault(),(0,_jquery.default)(".carousel").carousel(2),(0,_jquery.default)(".carousel").carousel("pause"),DropAdd.init(itemsData,editor)}))},addAppearanceListener=()=>{document.querySelector(".tiny-stash-appearance").addEventListener("change",(e=>{let selectedelement=e.target.selectedOptions[0];"text"==selectedelement.value&&(document.querySelector(".snippet-label").classList.remove("d-none"),document.querySelector(".snippet-actiontext").classList.add("d-none")),"image"==selectedelement.value&&(document.querySelector(".snippet-label").classList.add("d-none"),document.querySelector(".snippet-actiontext").classList.add("d-none")),"imageandbutton"==selectedelement.value&&(document.querySelector(".snippet-label").classList.add("d-none"),document.querySelector(".snippet-actiontext").classList.remove("d-none"));let itemselect=document.querySelector(".tiny-stash-item-select").selectedOptions[0];setPreview(itemselect.dataset.id,itemselect.dataset.hash)}))},addTextAndImageListener=()=>{document.querySelector('input[name="actiontext"]').addEventListener("keyup",(e=>{if(!document.querySelector(".block-stash-item"))return;let buttontext=e.currentTarget.value;document.querySelector(".tiny-stash-button-preview").innerText=buttontext;let codearea=document.getElementsByClassName("tiny-stash-item-code");Snippet.setText(buttontext),codearea[0].innerText=Snippet.getImageAndText()})),document.querySelector('input[name="label"]').addEventListener("keyup",(()=>{if(!document.querySelector(".block-stash-item"))return;let itemnode=document.querySelector(".tiny-stash-item-select");setPreview(itemnode.selectedOptions[0].dataset.id,itemnode.selectedOptions[0].dataset.hash)}))},setPreview=(itemid,hashcode)=>{let appearanceselector=document.querySelector(".tiny-stash-appearance"),codearea=document.getElementsByClassName("tiny-stash-item-code"),buttontext="";buttontext="text"===appearanceselector.value?document.querySelector('input[name="label"]').value:document.querySelector('input[name="actiontext"]').value,Snippet=new _snippetmaker.default(hashcode,itemsData[itemid].name),Snippet.setText(buttontext),updatePreview(itemid,appearanceselector.value),"imageandbutton"===appearanceselector.value?codearea[0].innerText=Snippet.getImageAndText():"image"===appearanceselector.value?codearea[0].innerText=Snippet.getImage():codearea[0].innerText=Snippet.getText()},updatePreview=(itemid,previewtype)=>{let previewnode=document.querySelector(".preview");previewnode.children.forEach((child=>{previewnode.removeChild(child)}));let wrappingdiv=document.createElement("div");if(wrappingdiv.classList.add("block-stash-item"),"text"===previewtype){let textanchour=document.createElement("a");textanchour.setAttribute("href","#"),textanchour.innerText=document.querySelector('input[name="label"]').value,wrappingdiv.appendChild(textanchour)}else{let imagediv=document.createElement("div");if(imagediv.classList.add("item-image"),imagediv.style.backgroundImage="url("+itemsData[itemid].imageurl+")","imageandbutton"===previewtype){let buttondiv=document.createElement("div");buttondiv.classList.add("item-action");let button=document.createElement("button");button.classList.add("btn","btn-secondary","tiny-stash-button-preview"),button.setAttribute("disabled",!0);let temp=document.querySelector('input[name="actiontext"]');button.innerHTML=temp.value,buttondiv.appendChild(button),wrappingdiv.appendChild(imagediv),wrappingdiv.appendChild(buttondiv)}else wrappingdiv.appendChild(imagediv)}previewnode.appendChild(wrappingdiv)},formatTradeInformation=(tradedata,itemdata)=>{let data={};for(let tradedatum of tradedata){data[tradedatum.tradeid]={tradeid:tradedatum.tradeid,name:tradedatum.name,gaintitle:tradedatum.gaintitle,losstitle:tradedatum.losstitle,hashcode:tradedatum.hashcode,additems:[],lossitems:[]};for(let gainitem of tradedatum.additems)gainitem&&data[tradedatum.tradeid].additems.push({itemid:gainitem.itemid,quantity:gainitem.quantity,name:itemdata[gainitem.itemid].name,imageurl:itemdata[gainitem.itemid].imageurl});for(let lossitem of tradedatum.lossitems)lossitem&&data[tradedatum.tradeid].lossitems.push({itemid:lossitem.itemid,quantity:lossitem.quantity,name:itemdata[lossitem.itemid].name,imageurl:itemdata[lossitem.itemid].imageurl})}tradeData=data},setTradePreview=hashcode=>{let selecteditem={};for(let tradeinfo of Object.entries(tradeData))if(tradeinfo[1].hashcode==hashcode){selecteditem=tradeinfo[1];break}let tradepreviewnode=document.querySelector(".tiny-stash-trade-preview");AddItem.removeChildren(tradepreviewnode),_templates.default.render("tiny_stash/trade-preview",selecteditem).then(((html,js)=>{_templates.default.replaceNodeContents(tradepreviewnode,html,js)}))},getDropData=async contextid=>{try{return await WebService.getAllDropData(contextid)}catch(e){return{}}},getItemData=async courseid=>{try{return await WebService.getAllItemData(courseid)}catch(e){return{}}}}));

//# sourceMappingURL=ui.min.js.map