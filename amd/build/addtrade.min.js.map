{"version":3,"file":"addtrade.min.js","sources":["../src/addtrade.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add trades to a stash.\n *\n * @copyright 2023 Adrian Greeve <adriangreeve.com>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Fragment from 'core/fragment';\nimport {getContextId} from 'editor_tiny/options';\nimport {getCourseId} from 'tiny_stash/options';\nimport Templates from 'core/templates';\nimport $ from 'jquery';\nimport * as WebService from 'tiny_stash/webservice-calls';\n\nlet CourseId = 0;\nlet Status = 'ready';\nexport let TradeHash = '';\n\nexport const init = (editor) => {\n    let contextid = getContextId(editor);\n    CourseId = getCourseId(editor);\n    let courseid = CourseId;\n\n    let areanode = document.querySelector('.tiny-stash-trade');\n    Fragment.loadFragment('tiny_stash', 'add_trade_form', contextid ,{courseid}).then((html, js) => {\n        Templates.appendNodeContents(areanode, html, js);\n    });\n\n    Templates.render('tiny_stash/local/footers/add-trade-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n        addFooterListeners();\n    });\n};\n\n/**\n * Remove all the children from a node.\n *\n * @param {node} node - The node to remove the children from.\n */\nconst removeChildren = (node) => {\n    while (node.firstChild) {\n        node.removeChild(node.lastChild);\n    }\n};\n\nexport const setStatus = (newstatus) => {\n    Status = newstatus;\n};\n\nexport const getStatus = () => {\n    return Status;\n};\n\n/**\n * Add listeners to the footer buttons.\n */\nconst addFooterListeners = () => {\n    let backbutton = document.querySelector('button[data-action=\"back\"]');\n    backbutton.addEventListener('click', (e) => {\n        shiftBack(e);\n    });\n    let addbutton = document.querySelector('button[data-action=\"add\"]');\n    addbutton.addEventListener('click', (e) => {\n        saveTrade(e);\n    });\n};\n\n/**\n * Shift the carousel back.\n *\n * @param {event} e - The related event.\n */\nconst shiftBack = (e) => {\n    e.preventDefault();\n    $('.carousel').carousel(0);\n    $('.carousel').carousel('pause');\n    // Clear this page.\n    let areanode = document.querySelector('.tiny-stash-trade');\n    removeChildren(areanode);\n    // Replace footer.\n    Templates.render('tiny_stash/local/footers/main-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n    });\n};\n\nconst saveTrade = (e) => {\n    let formdata = document.querySelector('.tiny-stash-trade form');\n    // window.console.log(formdata);\n    let allitems = formdata.querySelectorAll('.block-stash-quantity');\n    let additems = [];\n    let lossitems = [];\n    for (let itemnode of allitems) {\n        let itemid = itemnode.name.match(/\\[(\\d+)\\]/)[1];\n        if (itemnode.attributes['name'].value.includes('add_item')) {\n            additems.push({itemid, quantity: itemnode.value});\n        } else {\n            lossitems.push({itemid, quantity: itemnode.value});\n        }\n    }\n    let data = {\n        'courseid' : formdata.querySelector('input[name=\"courseid\"]').value,\n        'stashid' : formdata.querySelector('input[name=\"stashid\"]').value,\n        'hashcode' : formdata.querySelector('input[name=\"hashcode\"]').value,\n        'title' : formdata.querySelector('input[name=\"title\"]').value,\n        'gain' : formdata.querySelector('input[name=\"gain\"]').value,\n        'loss' : formdata.querySelector('input[name=\"loss\"]').value,\n        'additems' : additems,\n        'lossitems' : lossitems,\n    };\n    // window.console.log(data);\n    WebService.createTrade(data).then((result) => {\n        TradeHash = result;\n        setStatus('Saved');\n        shiftBack(e);\n        // window.console.log(result);\n    });\n};\n"],"names":["CourseId","Status","TradeHash","editor","contextid","courseid","areanode","document","querySelector","loadFragment","then","html","js","appendNodeContents","render","modalfooter","removeChildren","addFooterListeners","node","firstChild","removeChild","lastChild","setStatus","newstatus","addEventListener","e","shiftBack","saveTrade","preventDefault","carousel","formdata","allitems","querySelectorAll","additems","lossitems","itemnode","itemid","name","match","attributes","value","includes","push","quantity","data","WebService","createTrade","result"],"mappings":";;;;;;q7BA4BIA,SAAW,EACXC,OAAS,QACFC,UAAY,8CAEFC,aACbC,WAAY,yBAAaD,QAC7BH,UAAW,yBAAYG,YACnBE,SAAWL,SAEXM,SAAWC,SAASC,cAAc,uCAC7BC,aAAa,aAAc,iBAAkBL,UAAW,CAACC,SAAAA,WAAWK,MAAK,CAACC,KAAMC,yBAC3EC,mBAAmBP,SAAUK,KAAMC,0BAGvCE,OAAO,4CAA6C,IAAIJ,MAAK,CAACC,KAAMC,UACtEG,YAAcR,SAASC,cAAc,iBAEzCQ,eAAeD,gCACLF,mBAAmBE,YAAaJ,KAAMC,IAChDK,+BASFD,eAAkBE,YACbA,KAAKC,YACRD,KAAKE,YAAYF,KAAKG,YAIjBC,UAAaC,YACtBtB,OAASsB,2DAGY,IACdtB,aAMLgB,mBAAqB,KACNV,SAASC,cAAc,8BAC7BgB,iBAAiB,SAAUC,IAClCC,UAAUD,MAEElB,SAASC,cAAc,6BAC7BgB,iBAAiB,SAAUC,IACjCE,UAAUF,OASZC,UAAaD,IACfA,EAAEG,qCACA,aAAaC,SAAS,uBACtB,aAAaA,SAAS,aAEpBvB,SAAWC,SAASC,cAAc,qBACtCQ,eAAeV,6BAELQ,OAAO,uCAAwC,IAAIJ,MAAK,CAACC,KAAMC,UACjEG,YAAcR,SAASC,cAAc,iBAEzCQ,eAAeD,gCACLF,mBAAmBE,YAAaJ,KAAMC,QAIlDe,UAAaF,QACXK,SAAWvB,SAASC,cAAc,0BAElCuB,SAAWD,SAASE,iBAAiB,yBACrCC,SAAW,GACXC,UAAY,OACX,IAAIC,YAAYJ,SAAU,KACvBK,OAASD,SAASE,KAAKC,MAAM,aAAa,GAC1CH,SAASI,WAAT,KAA4BC,MAAMC,SAAS,YAC3CR,SAASS,KAAK,CAACN,OAAAA,OAAQO,SAAUR,SAASK,QAE1CN,UAAUQ,KAAK,CAACN,OAAAA,OAAQO,SAAUR,SAASK,YAG/CI,KAAO,UACMd,SAAStB,cAAc,0BAA0BgC,cAClDV,SAAStB,cAAc,yBAAyBgC,eAC/CV,SAAStB,cAAc,0BAA0BgC,YACpDV,SAAStB,cAAc,uBAAuBgC,WAC/CV,SAAStB,cAAc,sBAAsBgC,WAC7CV,SAAStB,cAAc,sBAAsBgC,eACzCP,mBACCC,WAGlBW,WAAWC,YAAYF,MAAMlC,MAAMqC,4BAC/B7C,UAAY6C,OACZzB,UAAU,SACVI,UAAUD"}