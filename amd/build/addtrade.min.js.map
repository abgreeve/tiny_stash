{"version":3,"file":"addtrade.min.js","sources":["../src/addtrade.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add trades to a stash.\n *\n * @copyright 2023 Adrian Greeve <adriangreeve.com>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Fragment from 'core/fragment';\nimport {getContextId} from 'editor_tiny/options';\nimport {getCourseId} from 'tiny_stash/options';\nimport Templates from 'core/templates';\nimport $ from 'jquery';\nimport * as WebService from 'tiny_stash/webservice-calls';\nimport * as AddItem from 'tiny_stash/additem';\n\nlet CourseId = 0;\nlet Status = 'ready';\nexport let TradeHash = '';\nlet Footerlistenerenabled = false;\n\nexport const init = (editor) => {\n    let contextid = getContextId(editor);\n    CourseId = getCourseId(editor);\n    let courseid = CourseId;\n    Footerlistenerenabled = false;\n\n    let areanode = document.querySelector('.tiny-stash-trade');\n    Templates.render('tiny_stash/local/nav/trade-nav', {}).then((html, js) => {\n        Templates.appendNodeContents(areanode, html, js);\n        let addbuttonnode = document.querySelector('.tiny-stash-add-item[data-location=\"trade\"]');\n        addbuttonnode.addEventListener('click', (e) => {\n            e.preventDefault();\n            $('.carousel').carousel(1);\n            $('.carousel').carousel('pause');\n            let location = e.currentTarget.dataset.location;\n            Footerlistenerenabled = false;\n            AddItem.init(editor, location);\n        });\n    });\n\n    Fragment.loadFragment('tiny_stash', 'add_trade_form', contextid ,{courseid}).then((html, js) => {\n        Templates.appendNodeContents(areanode, html, js);\n    });\n\n    Templates.render('tiny_stash/local/footers/add-trade-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n        addFooterListeners();\n    });\n\n    $('.carousel').on('slid.bs.carousel', function (e) {\n        let tthing = e.relatedTarget;\n        if (tthing.classList.contains('tiny-stash-trade')) {\n            // This questionable looking code removes unused dialoge divs that mess with the z-index.\n            // Mainly from using the filepicker, it seems that the base background z-index count get incorrectly set.\n            // If we remove those before working on this page then the z-index works fine.\n            let unneededmodals = document.querySelectorAll('.moodle-dialogue-base[aria-hidden=\"true\"]');\n            for (let nodes of unneededmodals) {\n                nodes.remove();\n            }\n\n            addFooterListeners();\n            // check additem status\n            let newitem = AddItem.getItem();\n            let data = {\n                id: newitem.id,\n                itemid: newitem.id,\n                name: newitem.name,\n                quantity: 1,\n                imageurl: newitem.imageurl,\n            };\n            if (AddItem.getStatus() == 'gain') {\n                // if gain add item to gain column\n                Templates.render('block_stash/trade_add_item_detail', data).then((html, js) => {\n                    let tablenode = document.querySelector('.block_stash_item_box[data-type=\"gain\"]>tbody');\n                    Templates.appendNodeContents(tablenode, html, js);\n                    registerActions();\n                });\n            }\n            if (AddItem.getStatus() == 'loss') {\n                // if loss add item to loss column\n                Templates.render('block_stash/trade_loss_item_detail', data).then((html, js) => {\n                    let tablenode = document.querySelector('.block_stash_item_box[data-type=\"loss\"]>tbody');\n                    Templates.appendNodeContents(tablenode, html, js);\n                    registerActions();\n                });\n            }\n            AddItem.setStatus('Clear');\n        }\n    });\n};\n\n/**\n * Remove all the children from a node.\n *\n * @param {node} node - The node to remove the children from.\n */\nconst removeChildren = (node) => {\n    while (node.firstChild) {\n        node.removeChild(node.lastChild);\n    }\n};\n\nexport const setStatus = (newstatus) => {\n    Status = newstatus;\n};\n\nexport const getStatus = () => {\n    return Status;\n};\n\nconst registerActions = () => {\n    let deleteelements = document.getElementsByClassName('block-stash-delete-item');\n    for (let delement of deleteelements) {\n        delement.addEventListener('click', deleteItem);\n    }\n};\n\nconst deleteItem = (element) => {\n    let child = element.currentTarget;\n    let parent = child.closest('.block-stash-trade-item');\n    parent.remove();\n    element.preventDefault();\n};\n\n/**\n * Add listeners to the footer buttons.\n */\nconst addFooterListeners = () => {\n    // For some reason slid.bs.carousel gets fired more than once depending on how often you've visited this page.\n    // So to avoid adding listeners more than once, we check first.\n    if (Footerlistenerenabled) {\n        return;\n    }\n    let backbutton = document.querySelector('button[data-action=\"back\"]');\n    backbutton.addEventListener('click', (e) => {\n        e.preventDefault();\n        moveBack(e);\n    });\n    let addbutton = document.querySelector('button[data-action=\"add\"]');\n    addbutton.addEventListener('click', (e) => {\n        saveTrade(e);\n    });\n    Footerlistenerenabled = true;\n};\n\n/**\n * Shift the carousel back.\n *\n * @param {event} e - The related event.\n */\nconst moveBack = (e) => {\n    e.preventDefault();\n    $('.carousel').carousel(0);\n    let slider = $('.carousel').carousel();\n    slider.carousel('pause');\n    // Clear this page.\n    let areanode = document.querySelector('.tiny-stash-trade');\n    removeChildren(areanode);\n    // Replace footer.\n    Templates.render('tiny_stash/local/footers/main-footer', {}).then((html, js) => {\n        let modalfooter = document.querySelector('.modal-footer');\n        // Footerlistenerenabled = false;\n        // Remove existing buttons.\n        removeChildren(modalfooter);\n        Templates.appendNodeContents(modalfooter, html, js);\n    });\n};\n\nconst saveTrade = (e) => {\n    let formdata = document.querySelector('.tiny-stash-trade form');\n    let allitems = formdata.querySelectorAll('.block-stash-quantity');\n    let additems = [];\n    let lossitems = [];\n    for (let itemnode of allitems) {\n        let itemid = itemnode.name.match(/\\[(\\d+)\\]/)[1];\n        if (itemnode.attributes['name'].value.includes('add_item')) {\n            additems.push({itemid, quantity: itemnode.value});\n        } else {\n            lossitems.push({itemid, quantity: itemnode.value});\n        }\n    }\n    let data = {\n        'courseid' : formdata.querySelector('input[name=\"courseid\"]').value,\n        'stashid' : formdata.querySelector('input[name=\"stashid\"]').value,\n        'hashcode' : formdata.querySelector('input[name=\"hashcode\"]').value,\n        'title' : formdata.querySelector('input[name=\"title\"]').value,\n        'gain' : formdata.querySelector('input[name=\"gain\"]').value,\n        'loss' : formdata.querySelector('input[name=\"loss\"]').value,\n        'additems' : additems,\n        'lossitems' : lossitems,\n    };\n    WebService.createTrade(data).then((result) => {\n        TradeHash = result;\n        setStatus('Saved');\n        moveBack(e);\n    });\n};\n"],"names":["CourseId","Status","TradeHash","Footerlistenerenabled","editor","contextid","courseid","areanode","document","querySelector","render","then","html","js","appendNodeContents","addEventListener","e","preventDefault","carousel","location","currentTarget","dataset","AddItem","init","loadFragment","modalfooter","removeChildren","addFooterListeners","on","relatedTarget","classList","contains","unneededmodals","querySelectorAll","nodes","remove","newitem","getItem","data","id","itemid","name","quantity","imageurl","getStatus","tablenode","registerActions","setStatus","node","firstChild","removeChild","lastChild","newstatus","deleteelements","getElementsByClassName","delement","deleteItem","element","closest","moveBack","saveTrade","formdata","allitems","additems","lossitems","itemnode","match","attributes","value","includes","push","WebService","createTrade","result"],"mappings":"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"}