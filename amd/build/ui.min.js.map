{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny stash UI.\n *\n * @module      tiny_stash/ui\n * @copyright   2023 Adrian Greeve <adriangreeve.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport Ajax from 'core/ajax';\nimport {getContextId} from 'editor_tiny/options';\nimport {getCourseId} from 'tiny_stash/options';\nimport $ from 'jquery';\nimport * as DropAdd from 'tiny_stash/drop-add';\nimport * as AddItem from 'tiny_stash/additem';\nimport SnippetMaker from 'tiny_stash/local/classes/snippetmaker';\n\nlet itemsData = {};\nlet Snippet = {};\n\n/**\n * Handle action\n * @param {TinyMCE} editor\n */\nexport const handleAction = (editor) => {\n    displayDialogue(editor);\n};\n\n/**\n * Display the drop dialogue.\n *\n * @param {TinyMCE} editor\n * @returns {Promise<void>}\n */\nconst displayDialogue = async(editor) => {\n    let contextid = getContextId(editor);\n    let data = await getAllDropData(contextid);\n    let courseid = getCourseId(editor);\n    let itemdata = await getAllItemData(courseid);\n    itemdata.items.forEach((item) => {\n        itemsData[item.id] = item;\n    });\n    // window.console.log(data);\n\n    const modalPromises = await ModalFactory.create({\n        title: \"Stash stuff here\",\n        type: ModalFactory.types.SAVE_CANCEL,\n        body: Templates.render('tiny_stash/drop-code-selector', data),\n        large: true,\n    });\n\n    modalPromises.show();\n    const $root = await modalPromises.getRoot();\n    const root = $root[0];\n\n    let savedata = {};\n\n    $root.on(ModalEvents.hidden, () => {\n        modalPromises.destroy();\n    });\n\n    $root.on(ModalEvents.bodyRendered, () => {\n        addAddDropListener(editor);\n\n        // Add a listener for the appearance select box.\n        addAppearanceListener();\n        addTextAndImageListener();\n\n        let additembutton = document.querySelector('.tiny-stash-add-item');\n        additembutton.addEventListener('click', (e) => {\n            e.preventDefault();\n            $('.carousel').carousel('next');\n            $('.carousel').carousel('pause');\n            AddItem.init(courseid, contextid);\n        });\n\n        $('.carousel').on('slide.bs.carousel', async () => {\n            if (DropAdd.Status == 'Saved') {\n                // Reload the drop list.\n                data = await getAllDropData(contextid);\n                Templates.render('tiny_stash/drop-select', data).then((html, js) => {\n                    let selectnode = document.querySelector('.tiny-stash-drop-select');\n                    Templates.replaceNodeContents(selectnode, html, js);\n                    addAddDropListener(editor);\n                });\n                DropAdd.Status = 'Clear';\n            }\n        });\n    });\n\n    $root.on(ModalEvents.save, () => {\n        let activetab = document.querySelector('[aria-selected=\"true\"][data-tiny-stash]');\n        let codearea = '';\n        if (activetab.getAttribute('aria-controls') == 'items') {\n            codearea = document.getElementsByClassName('tiny-stash-item-code');\n        } else {\n            codearea = document.getElementsByClassName('tiny-stash-trade-code');\n        }\n        savedata.codearea = codearea[0].innerText;\n        editor.execCommand('mceInsertContent', false, savedata.codearea);\n    });\n\n    root.addEventListener('click', (event) => {\n        let element = event.target;\n        let elementtype = element.dataset.type;\n        if (element.nodeName === \"OPTION\" && elementtype == 'item') {\n            let itemid = element.dataset.id;\n            let codearea = document.getElementsByClassName('tiny-stash-item-code');\n            let buttontext = document.querySelector('input[name=\"actiontext\"]').value;\n            Snippet = new SnippetMaker(element.dataset.hash, itemsData[itemid].name);\n            Snippet.setText(buttontext);\n            updatePreview(itemid);\n            codearea[0].innerText = Snippet.getImageAndText();\n        }\n        if (element.nodeName === \"OPTION\" && elementtype == 'trade') {\n            let codearea = document.getElementsByClassName('tiny-stash-trade-code');\n            let dropcode = \"[stashtrade secret=\\\"\" + element.dataset.hash + \"\\\"]\";\n            codearea[0].innerText = dropcode;\n        }\n    });\n};\n\nconst addAddDropListener = (editor) => {\n    let temp = document.getElementsByClassName('tiny-stash-add-drop');\n    temp[0].addEventListener('click', (e) => {\n        e.preventDefault();\n        $('.carousel').carousel('next');\n        $('.carousel').carousel('pause');\n        // init drop add page.\n        DropAdd.init(itemsData, editor);\n    });\n};\n\nconst addAppearanceListener = () => {\n    let selectnode = document.querySelector('.tiny-stash-appearance');\n    selectnode.addEventListener('change', (e) => {\n        let selectedelement = e.target.selectedOptions[0];\n        if (selectedelement.value == 'text') {\n            document.querySelector('.snippet-label').classList.remove('d-none');\n            document.querySelector('.snippet-actiontext').classList.add('d-none');\n        }\n        if (selectedelement.value == 'image') {\n            document.querySelector('.snippet-label').classList.add('d-none');\n            document.querySelector('.snippet-actiontext').classList.add('d-none');\n        }\n        if (selectedelement.value == 'imageandbutton') {\n            document.querySelector('.snippet-label').classList.add('d-none');\n            document.querySelector('.snippet-actiontext').classList.remove('d-none');\n        }\n\n    });\n};\n\nconst addTextAndImageListener = () => {\n    let textnode = document.querySelector('input[name=\"actiontext\"]');\n\n    textnode.addEventListener('keyup', (e) => {\n        // if no preview exit early.\n        if (!document.querySelector('.block-stash-item')) {\n            return;\n        }\n        let buttontext = e.currentTarget.value;\n        let previewbutton = document.querySelector('.tiny-stash-button-preview');\n        previewbutton.innerText = buttontext;\n        // Update the snippet text.\n        let codearea = document.getElementsByClassName('tiny-stash-item-code');\n        Snippet.setText(buttontext);\n        codearea[0].innerText = Snippet.getImageAndText();\n    });\n};\n\n/**\n * Update the preview image.\n *\n * @param {int} itemid\n */\nconst updatePreview = (itemid) => {\n    let previewnode = document.querySelector('.preview');\n    previewnode.children.forEach((child) => { previewnode.removeChild(child); });\n\n    let wrappingdiv = document.createElement('div');\n    wrappingdiv.classList.add('block-stash-item');\n    let imagediv = document.createElement('div');\n    imagediv.classList.add('item-image');\n    imagediv.style.backgroundImage = 'url(' + itemsData[itemid].imageurl + ')';\n    let buttondiv = document.createElement('div');\n    buttondiv.classList.add('item-action');\n    let button = document.createElement('button');\n    button.classList.add('btn');\n    button.classList.add('btn-secondary');\n    button.classList.add('tiny-stash-button-preview');\n    let temp = document.querySelector('input[name=\"actiontext\"]');\n    button.innerHTML = temp.value;\n    buttondiv.appendChild(button);\n    wrappingdiv.appendChild(imagediv);\n    wrappingdiv.appendChild(buttondiv);\n    previewnode.appendChild(wrappingdiv);\n};\n\n/**\n * Get all drop data.\n *\n * @param {int} contextid - The context id.\n * @returns {Promise<void>}\n */\nconst getAllDropData = (contextid) => Ajax.call([{\n    methodname: 'block_stash_get_all_drops',\n    args: {contextid: contextid}\n}])[0];\n\n/**\n * Get all item data.\n *\n * @param {int} courseid - The course id.\n * @returns {Promise<void>}\n */\nconst getAllItemData = (courseid) => Ajax.call([{\n    methodname: 'block_stash_get_items',\n    args: {courseid: courseid}\n}])[0];\n"],"names":["itemsData","Snippet","editor","displayDialogue","async","contextid","data","getAllDropData","courseid","getAllItemData","items","forEach","item","id","modalPromises","ModalFactory","create","title","type","types","SAVE_CANCEL","body","Templates","render","large","show","$root","getRoot","root","savedata","on","ModalEvents","hidden","destroy","bodyRendered","addAddDropListener","addAppearanceListener","addTextAndImageListener","document","querySelector","addEventListener","e","preventDefault","carousel","AddItem","init","DropAdd","Status","then","html","js","selectnode","replaceNodeContents","save","codearea","getAttribute","getElementsByClassName","innerText","execCommand","event","element","target","elementtype","dataset","nodeName","itemid","buttontext","value","SnippetMaker","hash","name","setText","updatePreview","getImageAndText","dropcode","selectedelement","selectedOptions","classList","remove","add","currentTarget","previewnode","children","child","removeChild","wrappingdiv","createElement","imagediv","style","backgroundImage","imageurl","buttondiv","button","temp","innerHTML","appendChild","Ajax","call","methodname","args"],"mappings":"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"}