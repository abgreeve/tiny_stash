define("tiny_stash/addtrade",["exports","core/fragment","editor_tiny/options","tiny_stash/options","core/templates","jquery","tiny_stash/webservice-calls","tiny_stash/additem"],(function(_exports,_fragment,_options,_options2,_templates,_jquery,WebService,AddItem){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Add trades to a stash.
   *
   * @copyright 2023 Adrian Greeve <adriangreeve.com>
   * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.setStatus=_exports.init=_exports.getStatus=_exports.TradeHash=void 0,_fragment=_interopRequireDefault(_fragment),_templates=_interopRequireDefault(_templates),_jquery=_interopRequireDefault(_jquery),WebService=_interopRequireWildcard(WebService),AddItem=_interopRequireWildcard(AddItem);let CourseId=0,Status="ready",TradeHash="";_exports.TradeHash=TradeHash;let Footerlistenerenabled=!1;_exports.init=editor=>{let contextid=(0,_options.getContextId)(editor);CourseId=(0,_options2.getCourseId)(editor);let courseid=CourseId;Footerlistenerenabled=!1;let areanode=document.querySelector(".tiny-stash-trade");_templates.default.render("tiny_stash/local/nav/trade-nav",{}).then(((html,js)=>{_templates.default.appendNodeContents(areanode,html,js),document.querySelector('.tiny-stash-add-item[data-location="trade"]').addEventListener("click",(e=>{e.preventDefault(),(0,_jquery.default)(".carousel").carousel(1),(0,_jquery.default)(".carousel").carousel("pause");let location=e.currentTarget.dataset.location;Footerlistenerenabled=!1,AddItem.init(editor,location)}))})),_fragment.default.loadFragment("tiny_stash","add_trade_form",contextid,{courseid:courseid}).then(((html,js)=>{_templates.default.appendNodeContents(areanode,html,js)})),_templates.default.render("tiny_stash/local/footers/add-trade-footer",{}).then(((html,js)=>{let modalfooter=document.querySelector(".modal-footer");removeChildren(modalfooter),_templates.default.appendNodeContents(modalfooter,html,js),addFooterListeners()})),(0,_jquery.default)(".carousel").on("slid.bs.carousel",(function(e){if(e.relatedTarget.classList.contains("tiny-stash-trade")){let unneededmodals=document.querySelectorAll('.moodle-dialogue-base[aria-hidden="true"]');for(let nodes of unneededmodals)nodes.remove();addFooterListeners();let newitem=AddItem.getItem(),data={id:newitem.id,itemid:newitem.id,name:newitem.name,quantity:1,imageurl:newitem.imageurl};"gain"==AddItem.getStatus()&&_templates.default.render("block_stash/trade_add_item_detail",data).then(((html,js)=>{let tablenode=document.querySelector('.block_stash_item_box[data-type="gain"]>tbody');_templates.default.appendNodeContents(tablenode,html,js),registerActions()})),"loss"==AddItem.getStatus()&&_templates.default.render("block_stash/trade_loss_item_detail",data).then(((html,js)=>{let tablenode=document.querySelector('.block_stash_item_box[data-type="loss"]>tbody');_templates.default.appendNodeContents(tablenode,html,js),registerActions()})),AddItem.setStatus("Clear")}}))};const removeChildren=node=>{for(;node.firstChild;)node.removeChild(node.lastChild)},setStatus=newstatus=>{Status=newstatus};_exports.setStatus=setStatus;_exports.getStatus=()=>Status;const registerActions=()=>{let deleteelements=document.getElementsByClassName("block-stash-delete-item");for(let delement of deleteelements)delement.addEventListener("click",deleteItem)},deleteItem=element=>{element.currentTarget.closest(".block-stash-trade-item").remove(),element.preventDefault()},addFooterListeners=()=>{if(Footerlistenerenabled)return;document.querySelector('button[data-action="back"]').addEventListener("click",(e=>{e.preventDefault(),moveBack(e)})),document.querySelector('button[data-action="add"]').addEventListener("click",(e=>{saveTrade(e)})),Footerlistenerenabled=!0},moveBack=e=>{e.preventDefault(),(0,_jquery.default)(".carousel").carousel(0),(0,_jquery.default)(".carousel").carousel().carousel("pause");let areanode=document.querySelector(".tiny-stash-trade");removeChildren(areanode),_templates.default.render("tiny_stash/local/footers/main-footer",{}).then(((html,js)=>{let modalfooter=document.querySelector(".modal-footer");removeChildren(modalfooter),_templates.default.appendNodeContents(modalfooter,html,js)}))},saveTrade=e=>{let formdata=document.querySelector(".tiny-stash-trade form"),allitems=formdata.querySelectorAll(".block-stash-quantity"),additems=[],lossitems=[];for(let itemnode of allitems){let itemid=itemnode.name.match(/\[(\d+)\]/)[1];itemnode.attributes.name.value.includes("add_item")?additems.push({itemid:itemid,quantity:itemnode.value}):lossitems.push({itemid:itemid,quantity:itemnode.value})}let data={courseid:formdata.querySelector('input[name="courseid"]').value,stashid:formdata.querySelector('input[name="stashid"]').value,hashcode:formdata.querySelector('input[name="hashcode"]').value,title:formdata.querySelector('input[name="title"]').value,gain:formdata.querySelector('input[name="gain"]').value,loss:formdata.querySelector('input[name="loss"]').value,additems:additems,lossitems:lossitems};WebService.createTrade(data).then((result=>{_exports.TradeHash=TradeHash=result,setStatus("Saved"),moveBack(e)}))}}));

//# sourceMappingURL=addtrade.min.js.map