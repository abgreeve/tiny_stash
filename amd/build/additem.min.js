define("tiny_stash/additem",["exports","core/fragment","core/templates","jquery","core/toast","tiny_stash/webservice-calls","editor_tiny/options","tiny_stash/options","tiny_stash/drop-add","core/str","block_stash/local/datasources/items-getter"],(function(_exports,_fragment,_templates,_jquery,Toast,WebService,_options,_options2,DropAdd,_str,itemGetter){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Add a new item internal
   *
   * @copyright  2023 Adrian Greeve <adriangreeve.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.setStatus=_exports.removeChildren=_exports.init=_exports.getStatus=_exports.getItem=void 0,_fragment=_interopRequireDefault(_fragment),_templates=_interopRequireDefault(_templates),_jquery=_interopRequireDefault(_jquery),Toast=_interopRequireWildcard(Toast),WebService=_interopRequireWildcard(WebService),DropAdd=_interopRequireWildcard(DropAdd),itemGetter=_interopRequireWildcard(itemGetter);let CourseId=0,Editor={},Status="Clear",Item={};_exports.init=(editor,location)=>{Editor=editor;let contextid=(0,_options.getContextId)(editor);CourseId=(0,_options2.getCourseId)(editor);let courseid=CourseId,areanode=document.querySelector(".tiny-stash-next-slide");_fragment.default.loadFragment("tiny_stash","add_item_form",contextid,{courseid:courseid}).then(((html,js)=>{_templates.default.appendNodeContents(areanode,html,js)}));let footerdata={};"location"==location&&(footerdata.location=!0),"trade"==location&&(footerdata.trade=!0),_templates.default.render("tiny_stash/local/footers/add-item-footer",footerdata).then(((html,js)=>{let modalfooter=document.querySelector(".modal-footer");removeChildren(modalfooter),_templates.default.appendNodeContents(modalfooter,html,js),addFooterListeners(location)}))};_exports.setStatus=newstatus=>{Status=newstatus};_exports.getStatus=()=>Status;_exports.getItem=()=>Item;const removeChildren=node=>{for(;node.firstChild;)node.removeChild(node.lastChild)};_exports.removeChildren=removeChildren;const addFooterListeners=location=>{if(document.querySelector('button[data-action="back"]').addEventListener("click",(e=>{shiftBack(e,location)})),"location"==location){document.querySelector('button[data-action="add"]').addEventListener("click",(e=>{saveItem(e,"save")})),document.querySelector('button[data-action="add-and-location"]').addEventListener("click",(e=>{saveItem(e,"savelocation")}))}else{document.querySelector('button[data-action="add-gain"]').addEventListener("click",(e=>{saveItem(e,"gain")})),document.querySelector('button[data-action="add-loss"]').addEventListener("click",(e=>{saveItem(e,"loss")}))}},shiftBack=(e,location)=>{e.preventDefault(),"trade"==location?(0,_jquery.default)(".carousel").carousel(3):(0,_jquery.default)(".carousel").carousel("prev"),(0,_jquery.default)(".carousel").carousel("pause");let areanode=document.querySelector(".tiny-stash-next-slide");removeChildren(areanode),"trade"==location?_templates.default.render("tiny_stash/local/footers/add-trade-footer",{}).then(((html,js)=>{let modalfooter=document.querySelector(".modal-footer");removeChildren(modalfooter),_templates.default.appendNodeContents(modalfooter,html,js)})):_templates.default.render("tiny_stash/local/footers/main-footer",{}).then(((html,js)=>{let modalfooter=document.querySelector(".modal-footer");removeChildren(modalfooter),_templates.default.appendNodeContents(modalfooter,html,js)}))},saveItem=(event,aftersave)=>{let formdata=document.querySelector(".tiny-stash-next-slide form"),submitdata={itemname:formdata.querySelector("#id_name").value,scarceitem:formdata.querySelector("#id_scarceitem").checked,amountlimit:formdata.querySelector("#id_amountlimit").value?formdata.querySelector("#id_amountlimit").value:0,itemimage:formdata.querySelector("#id_image").value,description:formdata.querySelector("#id_detail_text").value};validateForm(submitdata).then((result=>{result&&WebService.createItem(CourseId,submitdata).then((itemdata=>{itemGetter.resetCache(),Status="Saved","savelocation"==aftersave?addLocation(event,itemdata):"save"==aftersave?shiftBack(event):"gain"==aftersave?(Status="gain",Item=itemdata,shiftBack(event,"trade")):(Status="loss",Item=itemdata,shiftBack(event,"trade"))}))}))},addLocation=(e,itemdata)=>{e.preventDefault(),(0,_jquery.default)(".carousel").carousel("next"),(0,_jquery.default)(".carousel").carousel("pause");let areanode=document.querySelector(".tiny-stash-next-slide");removeChildren(areanode),DropAdd.init({itemdata:itemdata},Editor)},validateForm=async formdata=>{if(window.console.log(formdata),await Toast.addToastRegion(document.querySelector(".tiny-stash-next-slide")),!formdata.itemname)return Toast.add((0,_str.get_string)("namewarning","tiny_stash"),{type:"warning",autohide:!0,closeButton:!0}),document.querySelector("#id_name").focus(),!1;return!(document.querySelector(".tiny-stash-next-slide form").querySelector(".fp-content").children.length<1)||(Toast.add((0,_str.get_string)("imagewarning","tiny_stash"),{type:"warning",autohide:!0,closeButton:!0}),document.querySelector("#id_image").focus(),!1)}}));

//# sourceMappingURL=additem.min.js.map